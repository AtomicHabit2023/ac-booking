<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC Cleaning Booking</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f4; padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 20px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        select, input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background-color: #06C755; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        .hidden { display: none; }
        #loading { text-align: center; color: #666; }
        .slot-btn { display: inline-block; width: 48%; margin: 1%; padding: 10px; background: #eef; border: 1px solid #dde; border-radius: 6px; text-align: center; cursor: pointer; }
        .slot-btn.selected { background: #06C755; color: white; border-color: #06C755; }
    </style>
</head>
<body>

<div class="card">
    <h1>ðŸ“… Book AC Cleaning</h1>

    <div id="loading">Loading available slots...</div>

    <div id="bookingForm" class="hidden">
        
        <label>1. Select Date</label>
        <select id="dateSelect" onchange="filterTimes()">
            <option value="">-- Choose Date --</option>
        </select>

        <div id="timeSection" class="hidden">
            <label>2. Select Time</label>
            <div id="timeContainer"></div>
        </div>

        <div id="roomSection" class="hidden">
            <label style="margin-top: 20px;">3. Room Number</label>
            <input type="number" id="roomNo" placeholder="e.g. 404" />

            <button id="submitBtn" onclick="submitBooking()">Confirm Booking</button>
        </div>
    </div>
</div>

<script>
    // *** PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE ***
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxxWDosCy6HToINWAuIYoEGNSU3JY7Rb_kxbVP2iFDOrk1VKZaG04HUW5V-o0x-i-WA/exec"; 
    
    let allSlots = [];
    let selectedDate = "";
    let selectedTime = "";
    let userLineId = "U_GUEST"; // Default if LIFF fails
    let userDisplayName = "Guest";

    // Initialize LIFF (Optional but recommended for auto-LineID)
    async function main() {
        try {
            await liff.init({ liffId: "2008642005-XE5GDdQV" }); // Put your LIFF ID here if you have one, or remove this block
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userLineId = profile.userId;
		userDisplayName = profile.displayName;
            }
        } catch (err) {
            console.log("LIFF Init failed", err);
        }
        fetchSlots();
    }
    
    // Fetch Data from Google Sheet
    function fetchSlots() {
        fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                allSlots = data;
                populateDates();
                document.getElementById("loading").classList.add("hidden");
                document.getElementById("bookingForm").classList.remove("hidden");
            })
            .catch(error => {
                alert("Error loading schedule. Please try again.");
                console.error(error);
            });
    }

    // Populate the Date Dropdown (Unique dates only)
    function populateDates() {
        const uniqueDates = [...new Set(allSlots.map(slot => slot.date))];
        const dateSelect = document.getElementById("dateSelect");
        
        uniqueDates.forEach(date => {
            let option = document.createElement("option");
            option.value = date;
            option.text = date;
            dateSelect.appendChild(option);
        });
    }

    // Show times for selected date
    function filterTimes() {
        selectedDate = document.getElementById("dateSelect").value;
        const timeContainer = document.getElementById("timeContainer");
        timeContainer.innerHTML = "";
        selectedTime = ""; // Reset time
        
        if (!selectedDate) {
            document.getElementById("timeSection").classList.add("hidden");
            return;
        }

        const filteredSlots = allSlots.filter(slot => slot.date === selectedDate);
        
        filteredSlots.forEach(slot => {
            let btn = document.createElement("div");
            btn.className = "slot-btn";
            btn.innerText = slot.time;
            btn.onclick = function() {
                // Remove 'selected' class from all others
                document.querySelectorAll(".slot-btn").forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                selectedTime = slot.time;
                document.getElementById("roomSection").classList.remove("hidden");
            };
            timeContainer.appendChild(btn);
        });

        document.getElementById("timeSection").classList.remove("hidden");
        document.getElementById("roomSection").classList.add("hidden");
    }

    // Submit Data to Google Sheet
    function submitBooking() {
        const roomNo = document.getElementById("roomNo").value;
        if (!roomNo || !selectedTime || !selectedDate) {
            alert("Please complete all fields.");
            return;
        }

        const btn = document.getElementById("submitBtn");
        btn.disabled = true;
        btn.innerText = "Booking...";

        const payload = {
            date: selectedDate,
            time: selectedTime,
            roomNo: roomNo,
            lineId: userLineId,
	    displayName: userDisplayName	
        };

        // Send POST request (using 'no-cors' mode is tricky with reading response, 
        // strictly speaking standard fetch to GAS requires simple content type or handling redirects. 
        // This method below is the standard robust way for GAS Web Apps).
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert("Booking Successful! See you on " + selectedDate + " at " + selectedTime);
                if (liff.isInClient()) liff.closeWindow();
                else location.reload();
            } else {
                alert("Error: " + data.message);
                btn.disabled = false;
                btn.innerText = "Confirm Booking";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            // Sometimes GAS returns opaque response in no-cors, assume success if no network error
            alert("Request sent. Please check your schedule."); 
        });
    }

    // Start
    // If you don't have a LIFF ID yet, just call fetchSlots() directly.
    // main(); 
    fetchSlots(); 

</script>

</body>
</html>
